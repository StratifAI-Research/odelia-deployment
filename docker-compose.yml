version: '3.8'

services:
  # OHIF Viewer service (main viewer)
  viewer:
    build:
      context: ../../
      dockerfile: Dockerfile
    image: ${DOCKER_HUB_USERNAME:-stratifai}/odelia-viewer:${TAG:-latest}
    container_name: odelia-viewer
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf
      - ./config/app-config.js:/usr/share/nginx/html/app-config.js
 #     - ./logs/nginx:/var/log/nginx
      - ./config/oauth2-proxy.cfg:/etc/oauth2-proxy/oauth2-proxy.cfg:ro
    ports:
      - '8081:8081'
    depends_on:
      - orthanc-viewer
      - keycloak
    networks:
      - odelia-network
    environment:
      - PUBLIC_URL=/
      - PORT=8081
    user: "nginx:nginx"

  # Orthanc Viewer service (for OHIF to connect to)
  orthanc-viewer:
    build:
      context: ./orthanc-routing-example/orthanc-viewer
      dockerfile: Dockerfile
    image: ${DOCKER_HUB_USERNAME:-stratifai}/odelia-orthanc-viewer:${TAG:-latest}
    hostname: orthanc-viewer
    container_name: odelia-orthanc-viewer
    volumes:
      - ./orthanc-routing-example/orthanc-viewer/orthanc.json:/etc/orthanc/orthanc.json:ro
      - ./orthanc-routing-example/orthanc-viewer/router.py:/python/router.py:ro
      - ./orthanc-routing-example/orthanc-viewer/feedback_routes.py:/python/feedback_routes.py:ro
      - ./orthanc-routing-example/orthanc-viewer/feedback_db.py:/python/feedback_db.py:ro
      - ./volumes/orthanc-viewer-db/:/var/lib/orthanc/db/
      - ./volumes/feedback-db/:/var/lib/odelia-feedback/
    restart: unless-stopped
    networks:
      - odelia-network
    ports:
      - '8000:8042' # HTTP port
      - '2000:4242' # DICOM port
    environment:
      - ORTHANC__NAME=orthanc-viewer
      - VERBOSE_ENABLED=true
      - VERBOSE_STARTUP=true
      - ORTHANC__PYTHON_SCRIPT=/python/router.py
      - ORTHANC__PYTHON_VERBOSE=true
      - ORTHANC_FEEDBACK_DB_DIR=/var/lib/odelia-feedback
      - ORTHANC_FEEDBACK_ENABLE_WAL=1

  # Orthanc Router service (main PACS)
  orthanc-router:
    build:
      context: ./orthanc-routing-example/orthanc-router
      dockerfile: Dockerfile
    hostname: orthanc-router
    container_name: odelia-orthanc-router
    volumes:
      - ./config/orthanc-router.json:/etc/orthanc/orthanc.json:ro
      - ./volumes/orthanc-router-db/:/var/lib/orthanc/db/
      - ./orthanc-routing-example/orthanc-router/server.py:/python/server.py
    restart: unless-stopped
    networks:
      - odelia-network
    ports:
      - '4242:4242' # DICOM port
      - '8042:8042' # HTTP port
    environment:
      - ORTHANC__NAME=orthanc-router
      - VERBOSE_ENABLED=true
      - VERBOSE_STARTUP=true
      - ORTHANC__PYTHON_SCRIPT=/python/server.py
      - ORTHANC__PYTHON_VERBOSE=true
      - MODEL_BACKEND_URL=http://breast-cancer-classification:5555
      - AI_TEXT=PROCESSED BY AI MODEL
      - AI_COLOR=blue
      - AI_NAME=Breast Cancer Classification Model
    depends_on:
      - breast-cancer-classification

  # Breast Cancer Classification Model
  breast-cancer-classification:
    build:
      context: ./orthanc-routing-example/MLIntegration/breast-cancer-classification
      dockerfile: Dockerfile
    container_name: odelia-breast-cancer-classification
    environment:
      ORTHANC_URL: "http://orthanc-router:8042"
      IMAGE_FOLDER: "./images"
      MODEL_PATH: "./models/resnet18_abrv_b=32_split0-0.pth"
    networks:
      - odelia-network
    ports:
      - '5555:5555'

  # Grafana for feedback analytics (reads SQLite via plugin)
  grafana:
    image: grafana/grafana:11.1.0
    container_name: odelia-grafana
    ports:
      - '3000:3000'
    user: "0:0"                          # run as root
    environment:
      - GF_INSTALL_PLUGINS=frser-sqlite-datasource
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=odelia
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./volumes/feedback-db/:/var/lib/odelia-feedback/
    depends_on:
      - orthanc-viewer
    networks:
      - odelia-network

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.5
    command: 'start-dev --import-realm'
    hostname: keycloak
    container_name: keycloak
    volumes:
      - ./config/ohif-keycloak-realm.json:/opt/keycloak/data/import/ohif-keycloak-realm.json
    environment:
      # Database
      KC_DB_URL_HOST: postgres
      KC_DB: postgres
      KC_DB_URL: 'jdbc:postgresql://postgres:5432/keycloak'
      KC_DB_SCHEMA: public
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KC_HOSTNAME_ADMIN_URL: http://localhost:8081/keycloak/
      KC_HOSTNAME_URL: http://localhost:8081/keycloak/
      KC_HOSTNAME_STRICT_BACKCHANNEL: true
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_PROXY: edge
      KC_PROXY_HEADERS: xforwarded
      KEYCLOAK_JDBC_PARAMS: connectTimeout=40000
      KC_LOG_LEVEL: INFO
      KC_HOSTNAME_DEBUG: true
      # added later
      PROXY_ADDRESS_FORWARDING: true
    ports:
      - 8080:8080
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - odelia-network
    healthcheck:
      test: [
          'CMD-SHELL',
          "exec 3<>/dev/tcp/YOUR_DOMAIN/8080;echo -e \"GET /health/ready HTTP/1.1\r

          host: http://localhost:8081\r

          Connection: close\r

          \r

          \" >&3;grep \"HTTP/1.1 200 OK\" <&3",
        ]
      interval: 1s
      timeout: 5s
      retries: 10
      start_period: 60s

  postgres:
    image: postgres:15
    hostname: postgres
    container_name: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    restart: unless-stopped
    networks:
      - odelia-network

volumes:
  postgres_data:
    driver: local

networks:
  odelia-network:
    driver: bridge
